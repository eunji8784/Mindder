<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ssafy.mindder.alarms.model.mapper.AlarmsMapper">
	<!-- fcm 토큰 등록 -->
	<update id="updateToken" parameterType="TokenUpdateDto">
		update mainuser set device_token = #{deviceToken} where user_idx = #{userIdx};
	</update>
	<!-- 알림을 보낸 / 받을 유저 정보 조회 -->
	<select id="selectDeviceToken" parameterType="int" resultMap="com.ssafy.resultmaps.alarmsUser">
		select (select nickname from mainuser where user_idx = #{senderUserIdx}) as sender_nickname, 
				nickname as receiver_nickname, device_token
		from mainuser
		where user_idx = #{receiverUserIdx};
	</select>
	<!-- 알림에 등록할 유저 프로필 이미지 조회 -->
	<select id="selectUserFileIdx" parameterType="int" resultType="int">
		select file_idx from mainuser where user_idx = #{userIdx}; 
	</select>
	<!-- 팔로우 알림 등록 -->
	<insert id="insertFollowAlarm" parameterType="int">
		insert into mainalarm(alarm_type, send_user_idx, receive_user_idx, file_idx) values(1, #{userIdx} ,#{targetUserIdx}, #{fileIdx});
	</insert>
	<!-- 알림 목록 조회 -->
	<select id="selectAlarms" parameterType="int" resultMap="com.ssafy.resultmaps.alarmList">
		select a.alarm_idx, a.alarm_type, a.send_user_idx, a.file_idx, a.feed_idx, a.like_type, a.update_date, u.nickname, a.is_read
		from mainalarm a
		join mainuser u
		on a.send_user_idx = u.user_idx
		where a.receive_user_idx = #{userIdx}
		order by alarm_idx desc;
	</select>
	<!-- 알림 읽음 처리 -->
	<update id="updateAlarm" parameterType="int">
		update mainalarm set is_read = 1 where alarm_idx = #{alarmIdx};
	</update>
	<!-- 알림 조회 -->
	<select id="selectAlarm" parameterType="int" resultType="String">
		select alarm_idx from mainalarm where alarm_idx = #{alarmIdx};
	</select>
</mapper>
